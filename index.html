<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SENTINEL-PRO VPP | 2026 能源調度中心</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+TC:wght@300;500;900&display=swap');
        :root { --primary: #00f2ff; --bg: #0d1117; }
        body { background: var(--bg); color: #e6edf3; font-family: 'Noto Sans TC', sans-serif; overflow-x: hidden; }
        .glass-card { background: rgba(22, 27, 34, 0.8); border: 1px solid #30363d; border-radius: 2rem; }
        .digital-num { font-family: 'Orbitron', sans-serif; font-variant-numeric: tabular-nums; display: inline-block; white-space: nowrap; }

        /* 修正：淨收益文字自動縮放防止溢出，並略為縮小 */
        .income-container { max-width: 100%; overflow: hidden; display: flex; align-items: center; }
        #income-val { font-size: clamp(1.2rem, 6vw, 2.4rem); line-height: 1; transition: all 0.3s ease; }

        .input-field { background: rgba(255, 255, 255, 0.05); border: 1px solid #30363d; border-radius: 0.75rem; padding: 0.75rem; width: 100%; font-family: 'Orbitron', sans-serif; color: var(--primary); outline: none; }
        .status-pill { padding: 4px 12px; border-radius: 99px; font-size: 10px; font-weight: 900; }
        .status-green { background: rgba(35, 134, 54, 0.2); color: #3fb950; border: 1px solid #238636; }
        .status-yellow { background: rgba(187, 128, 9, 0.2); color: #d29922; border: 1px solid #9e6a03; }
        .strategy-item { transition: 0.2s; cursor: pointer; border: 1px solid #30363d; }
        .strategy-item.active { border-color: var(--primary); background: rgba(0, 242, 255, 0.05); }
    </style>
</head>
<body class="p-4 md:p-10">
    <div class="max-w-6xl mx-auto space-y-6">
        <header class="glass-card p-6 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-gradient-to-tr from-cyan-500 to-blue-600 rounded-xl flex items-center justify-center font-black italic">E</div>
                <div>
                    <h1 class="text-xl font-black digital-num tracking-wider">SENTINEL-PRO <span class="text-cyan-400">VPP</span></h1>
                    <p id="systime" class="text-[9px] font-mono text-slate-500 uppercase"></p>
                </div>
            </div>
            <div class="flex gap-8">
                <div class="text-right">
                    <p class="text-[9px] text-slate-500 font-bold uppercase mb-1">備轉容量率</p>
                    <div class="flex items-center gap-2">
                        <span id="reserve-val" class="text-2xl font-black digital-num">--%</span>
                        <div id="status-light" class="status-pill status-green">供電充裕</div>
                    </div>
                </div>
                <div class="text-right border-l border-white/10 pl-8">
                    <p class="text-[9px] text-slate-500 font-bold uppercase mb-1">電網頻率</p>
                    <span id="freq-val" class="text-2xl font-black text-blue-400 digital-num">60.00 Hz</span>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <section class="lg:col-span-4 glass-card p-8 flex flex-col justify-between h-[380px]">
                <div>
                    <h3 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-6">本時段預期淨收益 (TWD)</h3>
                    <div class="income-container h-24">
                        <span id="income-val" class="font-black text-orange-400 digital-num">$ 0.00</span>
                    </div>
                    <div class="mt-6 grid grid-cols-2 gap-3">
                        <div class="p-3 bg-white/5 rounded-xl border border-white/5 text-center">
                            <p class="text-[9px] text-slate-500 uppercase mb-1">碳避減量</p>
                            <p class="text-md font-bold text-emerald-400 digital-num"><span id="co2-val">0.0</span> kg</p>
                        </div>
                        <div class="p-3 bg-white/5 rounded-xl border border-white/5 text-center">
                            <p class="text-[9px] text-slate-500 uppercase mb-1">收益加成</p>
                            <p class="text-md font-bold text-blue-400 digital-num">1.05x</p>
                        </div>
                    </div>
                </div>
                <div class="pt-6 border-t border-white/5">
                    <div class="flex justify-between text-[9px] font-bold mb-2 text-slate-500 uppercase">
                        <span>決策執行進度</span>
                        <span id="exec-percent" class="text-cyan-400">0%</span>
                    </div>
                    <div class="w-full bg-slate-800 h-1 rounded-full overflow-hidden">
                        <div id="exec-bar" class="h-full bg-cyan-500 transition-all duration-700" style="width: 0%"></div>
                    </div>
                </div>
            </section>

            <section class="lg:col-span-8 glass-card p-8 h-[380px]">
                <canvas id="mainChart"></canvas>
            </section>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <div id="strategy-grid" class="lg:col-span-8 grid grid-cols-1 md:grid-cols-3 gap-4">
                </div>
            
            <section class="lg:col-span-4 glass-card p-6 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[9px] text-slate-500 font-bold block mb-1">契約容量 (kW)</label>
                        <input type="number" id="contract-kw" value="1000" oninput="calculateAndSync()" class="input-field text-md font-bold">
                    </div>
                    <div>
                        <label class="text-[9px] text-slate-500 font-bold block mb-1">預計抑低容量 (kW)</label>
                        <input type="number" id="reduce-kw" value="200" oninput="calculateAndSync()" class="input-field text-md font-bold">
                    </div>
                </div>
                <button onclick="fetchTaipower()" class="w-full bg-slate-100 text-black py-3 rounded-xl font-black text-[10px] uppercase tracking-widest hover:bg-white active:scale-95 transition-all">
                    更新並同步數據
                </button>
            </section>
        </div>
    </div>

    <script>
        const plans = [
            { id: 1, name: "空調系統降載", kw: 50, profit: 4200, co2: 24.8, active: false },
            { id: 2, name: "儲能系統供電", kw: 150, profit: 12800, co2: 74.3, active: false },
            { id: 3, name: "照明自動減光", kw: 20, profit: 1600, co2: 9.9, active: false }
        ];

        const ctx = document.getElementById('mainChart').getContext('2d');
        const mainChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['16:00', '17:00', '18:00', '19:00', '20:00', '21:00'],
                datasets: [{
                    data: [14.2, 13.5, 9.8, 11.2, 10.5, 12.1],
                    borderColor: '#00f2ff', borderWidth: 2, tension: 0.4, fill: true, backgroundColor: 'rgba(0, 242, 255, 0.05)'
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false }, ticks: { color: '#475569', font: { size: 9 } } } } }
        });

        async function fetchTaipower() {
            const api_url = "https://corsproxy.io/?https://www.taipower.com.tw/d006/load_draw/data/load_supply_info.json";
            try {
                const res = await fetch(api_url);
                const data = await res.json();
                calculateAndSync(parseFloat(data.reserve_rate));
            } catch (e) {
                calculateAndSync(14.5);
            }
        }

        // 核心修正：加入契約容量連動公式
        function calculateAndSync(overrideRate = null) {
            const rate = overrideRate || parseFloat(document.getElementById('reserve-val').innerText) || 14.5;
            
            // 更新燈號
            const valEl = document.getElementById('reserve-val');
            const lightEl = document.getElementById('status-light');
            valEl.innerText = rate.toFixed(1) + "%";
            if (rate >= 10) { lightEl.innerText = "供電充裕"; lightEl.className = "status-pill status-green"; }
            else { lightEl.innerText = "供電吃緊"; lightEl.className = "status-pill status-yellow"; }

            // 參數讀取
            const contractKW = parseFloat(document.getElementById('contract-kw').value) || 0;
            const reduceKW = parseFloat(document.getElementById('reduce-kw').value) || 0;
            const activePlans = plans.filter(p => p.active);
            const planProfit = activePlans.reduce((sum, p) => sum + p.profit, 0);

            // 新公式：抑低收益 + (契約容量 * 基本費折減系數 0.2) + 方案收益
            const baseProfit = (reduceKW * 8.5 * 6 * 1.05);
            const contractBonus = (contractKW * 0.2 * 6); // 模擬契約容量對整體電費扣減的貢獻
            const totalProfit = baseProfit + contractBonus + planProfit;

            animateValue("income-val", totalProfit, "$ ");
            document.getElementById('co2-val').innerText = ((reduceKW * 6 * 0.495) + activePlans.reduce((sum, p) => sum + p.co2, 0)).toFixed(1);
            document.getElementById('freq-val').innerText = (59.98 + Math.random()*0.04).toFixed(2) + " Hz";
        }

        function renderPlans() {
            const grid = document.getElementById('strategy-grid');
            grid.innerHTML = plans.map((p, idx) => `
                <div onclick="togglePlan(${idx})" class="strategy-item glass-card p-5 flex flex-col justify-between h-36 ${p.active ? 'active' : ''}">
                    <h4 class="font-bold text-xs">${p.name}</h4>
                    <div class="text-right pt-4 border-t border-white/5">
                        <p class="text-lg font-black text-orange-400 digital-num">+$${p.profit.toLocaleString()}</p>
                        <p class="text-[8px] text-emerald-500 font-bold uppercase">-${p.kw}kW</p>
                    </div>
                </div>
            `).join('');
            const activeCount = plans.filter(p => p.active).length;
            document.getElementById('exec-percent').innerText = Math.round((activeCount/plans.length)*100) + "%";
            document.getElementById('exec-bar').style.width = (activeCount/plans.length*100) + "%";
        }

        function togglePlan(idx) {
            plans[idx].active = !plans[idx].active;
            renderPlans();
            calculateAndSync();
        }

        function animateValue(id, end, prefix = "") {
            const obj = document.getElementById(id);
            const start = parseFloat(obj.innerText.replace(/[^0-9.]/g, '')) || 0;
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / 500, 1);
                const val = (progress * (end - start) + start).toFixed(2);
                obj.innerText = prefix + parseFloat(val).toLocaleString(undefined, {minimumFractionDigits: 2});
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }

        window.onload = () => {
            renderPlans(); fetchTaipower();
            setInterval(() => { document.getElementById('systime').innerText = "SYNC_OK: " + new Date().toLocaleString(); }, 1000);
            setInterval(fetchTaipower, 60000);
        };
    </script>
</body>
</html>
