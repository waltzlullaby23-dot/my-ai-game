<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> | 需量競價結算系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+TC:wght@300;500;900&display=swap');
        :root { --primary: #00f2ff; --bg: #0d1117; --card-bg: rgba(22, 27, 34, 0.95); }
        body { background: var(--bg); color: #e6edf3; font-family: 'Noto Sans TC', sans-serif; }
        .glass-card { background: var(--card-bg); border: 1px solid #30363d; border-radius: 1.5rem; }
        .digital-num { font-family: 'Orbitron', sans-serif; font-variant-numeric: tabular-nums; }
        .input-field { background: #161b22; border: 1px solid #30363d; border-radius: 0.5rem; padding: 0.8rem; width: 100%; color: var(--primary); text-align: right; font-size: 1.25rem; }
        .label-text { font-size: 11px; color: #8b949e; font-weight: 700; margin-bottom: 6px; display: block; text-transform: uppercase; letter-spacing: 1px; }
        .btn-toggle { background: #161b22; border: 1px solid #30363d; padding: 12px; border-radius: 12px; transition: all 0.3s; color: #8b949e; font-weight: 900; }
        .btn-toggle.active { background: #1f6feb; border-color: #58a6ff; color: white; box-shadow: 0 0 20px rgba(31, 111, 235, 0.3); }
        .status-pill { background: rgba(35, 134, 54, 0.2); color: #3fb950; border: 1px solid #238636; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 900; }
        .sync-animation { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
    </style>
</head>
<body class="p-4 md:p-8 flex items-center justify-center min-h-screen">
    <div class="w-full max-w-6xl space-y-6">
        
        <header class="glass-card p-6 flex flex-col md:flex-row justify-between items-center gap-6 border-b border-cyan-500/30">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-cyan-500/10 rounded-xl flex items-center justify-center border border-cyan-500/30">
                    <span class="text-cyan-400 font-black text-xl digital-num">V</span>
                </div>
                <div>
                    <h1 class="text-xl font-black digital-num text-white tracking-tighter">SENTINEL-PRO <span class="text-cyan-400">VPP</span></h1>
                    <div class="flex items-center gap-2">
                        <span id="sync-dot" class="w-2 h-2 bg-emerald-500 rounded-full sync-animation"></span>
                        <p id="systime" class="text-[9px] font-mono text-slate-500 uppercase tracking-widest">SYSTEM_REALTIME_LOG: SYNCING...</p>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-12">
                <div class="text-right">
                    <p class="label-text">台電即時備轉容量率</p>
                    <div class="flex items-center justify-end gap-3">
                        <span id="reserve-val" class="text-4xl font-black digital-num text-white">--%</span>
                        <div id="sync-status" class="status-pill">SYNC</div>
                    </div>
                </div>
                <div class="text-right border-l border-white/10 pl-12">
                    <p class="label-text">當前電網頻率</p>
                    <span id="grid-freq" class="text-4xl font-black text-fuchsia-500 digital-num">60.00 <small class="text-xs">Hz</small></span>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <section class="lg:col-span-5 glass-card p-8 flex flex-col justify-between shadow-2xl relative overflow-hidden">
                <div class="absolute top-0 right-0 p-8 opacity-5">
                    <svg width="120" height="120" viewBox="0 0 24 24" fill="white"><path d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                </div>
                <div>
                    <h3 class="label-text text-cyan-400 mb-6">本時段 預期淨收益 (TWD)</h3>
                    <div class="mb-10">
                        <span id="monthly-val" class="text-6xl font-black digital-num text-emerald-400 tracking-tight">$ 0.00</span>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-10">
                        <div class="bg-white/5 p-4 rounded-2xl border border-white/5">
                            <p class="label-text text-slate-400">當前調度執行率</p>
                            <p id="exec-rate" class="text-3xl font-bold digital-num text-white">0%</p>
                        </div>
                        <div class="bg-white/5 p-4 rounded-2xl border border-white/5">
                            <p id="rate-label" class="label-text text-slate-400">收益加成比率</p>
                            <p id="discount-rate-ui" class="text-3xl font-bold digital-num text-orange-400">0%</p>
                        </div>
                    </div>

                    <div class="space-y-4 pt-6 border-t border-white/10">
                        <div class="flex justify-between items-end">
                            <span class="text-xs text-slate-500 font-bold uppercase">今日抑低總額</span>
                            <span id="daily-val" class="text-orange-400 font-black text-3xl digital-num">$ 0.00</span>
                        </div>
                    </div>
                </div>
            </section>

            <section class="lg:col-span-7 glass-card p-8 space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="col-span-full">
                        <label class="label-text text-cyan-500">調度通知類型</label>
                        <select id="notice-type" onchange="calculate()" class="input-field text-left font-bold">
                            <option value="two-hour">前 2 小時通知 (報價固定 × 120%)</option>
                            <option value="day-ahead">前一日下午 6 時前 (依執行率階梯)</option>
                        </select>
                    </div>

                    <div class="col-span-full">
                        <label class="label-text text-white">抑低時數選擇 (Hr)</label>
                        <div class="flex gap-4">
                            <button onclick="setHours(2)" id="btn-2h" class="btn-toggle flex-1 text-xl active">2 小時</button>
                            <button onclick="setHours(4)" id="btn-4h" class="btn-toggle flex-1 text-xl">4 小時</button>
                        </div>
                    </div>

                    <div>
                        <label class="label-text text-slate-400">抑低契約容量 (kW)</label>
                        <input type="number" id="target-kw" value="1000" oninput="calculate()" class="input-field">
                    </div>
                    <div>
                        <label class="label-text text-emerald-500">實際抑低容量 (kW)</label>
                        <input type="number" id="actual-kw" value="900" oninput="calculate()" class="input-field font-black text-emerald-400">
                    </div>
                    <div>
                        <label class="label-text text-slate-400">每度電報價 (TWD)</label>
                        <input type="number" id="bid-price" value="10" step="0.5" oninput="calculate()" class="input-field">
                    </div>
                    <div>
                        <label class="label-text text-slate-400">模擬本月執行次數</label>
                        <input type="number" id="monthly-count" value="10" oninput="calculate()" class="input-field">
                    </div>
                </div>

                <div class="p-5 bg-black/40 rounded-xl border border-white/5">
                    <p class="text-[10px] text-cyan-500 font-black mb-2 uppercase tracking-widest">Calculation Logic Trace</p>
                    <div id="formula-desc" class="text-xs text-slate-500 font-mono leading-relaxed">
                        </div>
                </div>
            </section>
        </div>
    </div>

    <script>
        let selectedHours = 2;

        // --- 核心：台電即時資料對接 ---
        async function fetchTaipowerData() {
            try {
                // 使用官方公開資料格式 API (透過 corsproxy 以利前端展示)
                const response = await fetch('https://corsproxy.io/?https://www.taipower.com.tw/d006/load_draw/data/load_supply_info.json');
                const data = await response.json();
                
                const rate = data.reserve_rate; // 備轉容量率
                document.getElementById('reserve-val').innerText = rate + "%";
                document.getElementById('sync-status').innerText = "LIVE";
                document.getElementById('sync-status').className = "status-pill";
            } catch (error) {
                console.error("Taipower API Sync Failed", error);
                document.getElementById('reserve-val').innerText = "12.4%"; // 斷線時顯示最後模擬值
                document.getElementById('sync-status').innerText = "OFFLINE";
                document.getElementById('sync-status').className = "status-pill opacity-50";
            }
        }

        // --- 頻率模擬 (未來即時分頁用) ---
        function simulateFrequency() {
            const base = 60.00;
            const jitter = (Math.random() - 0.5) * 0.04;
            document.getElementById('grid-freq').innerHTML = `${(base + jitter).toFixed(2)} <small class="text-xs">Hz</small>`;
        }

        function setHours(h) {
            selectedHours = h;
            document.getElementById('btn-2h').classList.toggle('active', h === 2);
            document.getElementById('btn-4h').classList.toggle('active', h === 4);
            calculate();
        }

        function calculate() {
            const noticeMode = document.getElementById('notice-type').value;
            const bidPrice = parseFloat(document.getElementById('bid-price').value) || 0;
            const targetKW = parseFloat(document.getElementById('target-kw').value) || 0;
            const actualKW = parseFloat(document.getElementById('actual-kw').value) || 0;
            const mCount = parseFloat(document.getElementById('monthly-count').value) || 0;

            let execRate = targetKW > 0 ? (actualKW / targetKW) * 100 : 0;
            let discountRate = 0;
            let dailyTotal = 0;
            let trace = "";

            // 邏輯 1：20kW 門檻
            if (actualKW < 20) {
                dailyTotal = 0;
                trace = "系統警告: 實際抑低未達 20kW 門檻，收益為 0。";
            } 
            // 邏輯 2：前 2 小時通知 (直接加成 120%)
            else if (noticeMode === "two-hour") {
                discountRate = 1.2; 
                dailyTotal = actualKW * selectedHours * bidPrice * discountRate;
                document.getElementById('rate-label').innerText = "固定加成 (2Hr通知)";
                document.getElementById('discount-rate-ui').innerText = "1.20x";
                trace = `[經濟型優待] ${actualKW}kW * ${selectedHours}h * ${bidPrice}元 * 1.20 = $${dailyTotal.toLocaleString()}`;
            } 
            // 邏輯 3：前一日通知 (階梯比率)
            else {
                document.getElementById('rate-label').innerText = "執行率扣減比率";
                if (execRate < 60) discountRate = 0;
                else if (execRate < 80) discountRate = 1.0;
                else if (execRate <= 120) discountRate = 1.1;
                else discountRate = 1.0;

                dailyTotal = actualKW * selectedHours * bidPrice * discountRate;
                document.getElementById('discount-rate-ui').innerText = (discountRate).toFixed(2) + "x";
                trace = `[階梯邏輯] 執行率 ${execRate.toFixed(1)}% -> 比率 ${discountRate*100}% | $${dailyTotal.toLocaleString()}`;
            }

            const monthlyTotal = dailyTotal * mCount;

            document.getElementById('exec-rate').innerText = execRate.toFixed(1) + "%";
            document.getElementById('formula-desc').innerText = trace;
            
            animateValue("daily-val", dailyTotal);
            animateValue("monthly-val", monthlyTotal);
        }

        function animateValue(id, value) {
            const el = document.getElementById(id);
            el.innerText = "$ " + value.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // --- 初始化與迴圈 ---
        window.onload = () => {
            fetchTaipowerData();
            calculate();
            setInterval(fetchTaipowerData, 600000); // 10分鐘更新一次備轉率
            setInterval(simulateFrequency, 1000); // 每秒模擬頻率跳動
            
            // 系統時間更新
            setInterval(() => {
                const now = new Date();
                document.getElementById('systime').innerText = `SYSTEM_REALTIME_LOG: ${now.toLocaleString()} [SYNC_OK]`;
            }, 1000
