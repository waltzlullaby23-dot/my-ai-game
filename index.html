<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SENTINEL VPP | 需量競價結算系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+TC:wght@300;500;900&display=swap');
        :root { --primary: #00f2ff; --bg: #0d1117; --card-bg: rgba(22, 27, 34, 0.95); }
        body { background: var(--bg); color: #e6edf3; font-family: 'Noto Sans TC', sans-serif; }
        .glass-card { background: var(--card-bg); border: 1px solid #30363d; border-radius: 1.5rem; }
        .digital-num { font-family: 'Orbitron', sans-serif; font-variant-numeric: tabular-nums; }
        .input-field { background: #161b22; border: 1px solid #30363d; border-radius: 0.5rem; padding: 0.8rem; width: 100%; color: var(--primary); text-align: right; font-size: 1.25rem; }
        .label-text { font-size: 11px; color: #8b949e; font-weight: 700; margin-bottom: 6px; display: block; text-transform: uppercase; letter-spacing: 1px; }
        .btn-toggle { background: #161b22; border: 1px solid #30363d; padding: 12px; border-radius: 12px; transition: all 0.3s; color: #8b949e; font-weight: 900; }
        .btn-toggle.active { background: #1f6feb; border-color: #58a6ff; color: white; box-shadow: 0 0 20px rgba(31, 111, 235, 0.3); }
        .status-pill { background: rgba(35, 134, 54, 0.2); color: #3fb950; border: 1px solid #238636; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 900; }
    </style>
</head>
<body class="p-4 md:p-8 flex items-center justify-center min-h-screen">
    <div class="w-full max-w-6xl space-y-6">
        
        <header class="glass-card p-6 flex flex-col md:flex-row justify-between items-center gap-6 border-b border-cyan-500/30">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-cyan-500/10 rounded-xl flex items-center justify-center border border-cyan-500/30">
                    <span class="text-cyan-400 font-black text-xl digital-num">V</span>
                </div>
                <div>
                    <h1 class="text-xl font-black digital-num text-white tracking-tighter">SENTINEL-PRO <span class="text-cyan-400">VPP</span></h1>
                    <p id="systime" class="text-[9px] font-mono text-slate-500 uppercase tracking-widest">REALTIME_LOG: CONNECTED</p>
                </div>
            </div>
            
            <div class="flex gap-12 text-right">
                <div>
                    <p class="label-text">台電即時備轉容量率</p>
                    <div class="flex items-center justify-end gap-3">
                        <span id="reserve-val" class="text-4xl font-black digital-num text-white">--%</span>
                        <div id="sync-status" class="status-pill">SYNCING</div>
                    </div>
                </div>
                <div class="border-l border-white/10 pl-12">
                    <p class="label-text">系統功率因素 (PF)</p>
                    <span class="text-4xl font-black text-cyan-400 digital-num">0.98</span>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <section class="lg:col-span-5 glass-card p-8 flex flex-col justify-between shadow-2xl">
                <div>
                    <h3 class="label-text text-cyan-400 mb-6 font-black">本月流動電費扣減預估 (TWD)</h3>
                    <div class="mb-10">
                        <span id="monthly-val" class="text-6xl font-black digital-num text-emerald-400 tracking-tight">$ 0.00</span>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-10">
                        <div class="bg-white/5 p-4 rounded-2xl border border-white/5">
                            <p class="label-text">當次執行率 (x)</p>
                            <p id="exec-rate" class="text-3xl font-bold digital-num text-white">0%</p>
                        </div>
                        <div class="bg-white/5 p-4 rounded-2xl border border-white/5">
                            <p id="rate-label" class="label-text">收益比率</p>
                            <p id="discount-rate-ui" class="text-3xl font-bold digital-num text-orange-400">--</p>
                        </div>
                    </div>

                    <div class="pt-6 border-t border-white/10">
                        <div class="flex justify-between items-end">
                            <span class="text-xs text-slate-500 font-bold uppercase">今日當次扣減總額</span>
                            <span id="daily-val" class="text-orange-400 font-black text-3xl digital-num">$ 0.00</span>
                        </div>
                    </div>
                </div>
            </section>

            <section class="lg:col-span-7 glass-card p-8 space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="col-span-full">
                        <label class="label-text text-cyan-500">調度通知時間設定</label>
                        <select id="notice-type" onchange="calculate()" class="input-field text-left font-bold">
                            <option value="two-hour">抑低用電前 2 小時通知 (固定 120%)</option>
                            <option value="day-ahead">前一日下午 6 時前通知 (依執行率階梯)</option>
                        </select>
                    </div>

                    <div class="col-span-full">
                        <label class="label-text text-white">抑低時數選擇 (Hr)</label>
                        <div class="flex gap-4">
                            <button onclick="setHours(2)" id="btn-2h" class="btn-toggle flex-1 text-xl active">2 小時</button>
                            <button onclick="setHours(4)" id="btn-4h" class="btn-toggle flex-1 text-xl">4 小時</button>
                        </div>
                    </div>

                    <div>
                        <label class="label-text text-slate-400">抑低契約容量 (kW)</label>
                        <input type="number" id="target-kw" value="1000" oninput="calculate()" class="input-field">
                    </div>
                    <div>
                        <label class="label-text text-emerald-500 font-bold">實際抑低容量 (kW)</label>
                        <input type="number" id="actual-kw" value="900" oninput="calculate()" class="input-field font-black text-emerald-400">
                    </div>
                    <div>
                        <label class="label-text text-slate-400">抑低用電每度報價 (元)</label>
                        <input type="number" id="bid-price" value="10" step="0.5" oninput="calculate()" class="input-field">
                    </div>
                    <div>
                        <label class="label-text text-slate-400">本月模擬執行次數</label>
                        <input type="number" id="monthly-count" value="10" oninput="calculate()" class="input-field">
                    </div>
                </div>

                <div class="p-5 bg-black/40 rounded-xl border border-white/5">
                    <p class="text-[10px] text-cyan-500 font-black mb-2 uppercase tracking-widest">台電官網結算邏輯追蹤 (Trace)</p>
                    <div id="formula-desc" class="text-xs text-slate-500 font-mono leading-relaxed">
                        </div>
                </div>
            </section>
        </div>
    </div>

    <script>
        let selectedHours = 2;

        async function fetchTaipowerData() {
            try {
                const response = await fetch('https://corsproxy.io/?https://www.taipower.com.tw/d006/load_draw/data/load_supply_info.json');
                const data = await response.json();
                document.getElementById('reserve-val').innerText = data.reserve_rate + "%";
                document.getElementById('sync-status').innerText = "LIVE";
                document.getElementById('sync-status').style.opacity = "1";
            } catch (e) {
                document.getElementById('reserve-val').innerText = "14.5%"; 
                document.getElementById('sync-status').innerText = "OFFLINE";
            }
        }

        function setHours(h) {
            selectedHours = h;
            document.getElementById('btn-2h').classList.toggle('active', h === 2);
            document.getElementById('btn-4h').classList.toggle('active', h === 4);
            calculate();
        }

        function calculate() {
            const noticeMode = document.getElementById('notice-type').value;
            const bidPrice = parseFloat(document.getElementById('bid-price').value) || 0;
            const targetKW = parseFloat(document.getElementById('target-kw').value) || 0;
            const actualKW = parseFloat(document.getElementById('actual-kw').value) || 0;
            const mCount = parseFloat(document.getElementById('monthly-count').value) || 0;

            // 1. 執行率 x = 實際 / 契約 * 100%
            let execRate = targetKW > 0 ? (actualKW / targetKW) * 100 : 0;
            let ratio = 0;
            let dailyTotal = 0;
            let trace = "";

            // 2. 判斷除外條款：未達 20kW 按 0 計算
            if (actualKW < 20) {
                ratio = 0;
                dailyTotal = 0;
                trace = "警告：實際抑低容量 < 20kW，依規定不予計入電費扣減。";
            } 
            // 3. 根據通知模式選擇公式
            else if (noticeMode === "two-hour") {
                // 前 2 小時通知：報價加 2 成 (120%)，不看執行率階梯
                ratio = 1.2;
                dailyTotal = actualKW * selectedHours * bidPrice * ratio;
                document.getElementById('rate-label').innerText = "報價加成 (固定)";
                document.getElementById('discount-rate-ui').innerText = "120%";
                trace = `公式(二)：${actualKW}kW × ${selectedHours}h × ${bidPrice}元 × 120% = $${dailyTotal.toLocaleString()}`;
            } else {
                // 前一日通知：看執行率階梯
                document.getElementById('rate-label').innerText = "扣減比率 (階梯)";
                if (execRate < 60) ratio = 0;
                else if (execRate < 80) ratio = 1.0;
                else if (execRate <= 120) ratio = 1.1;
                else ratio = 1.0;

                dailyTotal = actualKW * selectedHours * bidPrice * ratio;
                document.getElementById('discount-rate-ui').innerText = (ratio * 100) + "%";
                trace = `公式(一)：${actualKW}kW × ${selectedHours}h × ${bidPrice}元 × ${ratio*100}% (執行率x=${execRate.toFixed(1)}%) = $${dailyTotal.toLocaleString()}`;
            }

            const monthlyTotal = dailyTotal * mCount;

            // 更新 UI
            document.getElementById('exec-rate').innerText = execRate.toFixed(1) + "%";
            document.getElementById('formula-desc').innerText = trace;
            animateValue("daily-val", dailyTotal);
            animateValue("monthly-val", monthlyTotal);
        }

        function animateValue(id, value) {
            document.getElementById(id).innerText = "$ " + value.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        window.onload = () => {
            fetchTaipowerData();
            calculate();
            setInterval(fetchTaipowerData, 600000);
            setInterval(() => {
                document.getElementById('systime').innerText = `REALTIME_LOG: ${new Date().toLocaleString()} [SYNC_OK]`;
            }, 1000);
        };
    </script>
</body>
</html>
